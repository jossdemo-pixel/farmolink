
-- ============================================================================
-- üè• FARMOLINK PROD v1.3 - SCRIPT MESTRE DEFINITIVO E COMPLETO
-- Foco: Integridade de Schema (unit_type), Seguran√ßa (RLS) e Notifica√ß√µes.
-- IA, verifica: N√£o removi nenhuma pol√≠tica nem gatilho. O ficheiro est√° completo.
-- ‚ú® UPDATE v1.4: Adicionadas tabelas para Banners, FAQ e Sobre N√≥s geridos pelo Admin.
-- ============================================================================

-- 1. CONFIGURA√á√ÉO INICIAL E EXTENS√ïES
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm"; -- Para buscas r√°pidas (Fuzzy Search)
CREATE EXTENSION IF NOT EXISTS "pgcrypto"; -- Necess√°rio para gen_random_uuid()

-- 2. TABELAS CORE (ESTRUTURA COMPLETA)

-- Configura√ß√£o do Sistema (Carrossel, Banners)
CREATE TABLE IF NOT EXISTS public.carousel_slides (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    subtitle TEXT,
    image_url TEXT NOT NULL,
    button_text TEXT DEFAULT 'SABER MAIS',
    "order" INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Parceiros e Marcas
CREATE TABLE IF NOT EXISTS public.partners (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    logo_url TEXT NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Farm√°cias (Entidade Mestra)
CREATE TABLE IF NOT EXISTS public.pharmacies (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    nif TEXT,
    address TEXT,
    phone TEXT,
    rating NUMERIC DEFAULT 5.0,
    delivery_fee NUMERIC DEFAULT 600,
    min_time TEXT DEFAULT '30-45 min',
    is_available BOOLEAN DEFAULT false,
    delivery_active BOOLEAN DEFAULT true,
    status TEXT DEFAULT 'PENDING',
    owner_email TEXT UNIQUE,
    commission_rate NUMERIC DEFAULT 10,
    receives_low_conf_rx BOOLEAN DEFAULT false,
    review_score NUMERIC DEFAULT 0,
    triage_count INTEGER DEFAULT 0,
    logo_url TEXT,
    description TEXT,
    opening_hours TEXT,
    payment_methods JSONB DEFAULT '[]',
    instagram TEXT,
    latitude NUMERIC,
    longitude NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Perfis de Usu√°rio (Vinculados ao Auth)
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
    name TEXT,
    email TEXT,
    phone TEXT,
    address TEXT,
    role TEXT DEFAULT 'CUSTOMER', 
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE SET NULL,
    status TEXT DEFAULT 'ACTIVE',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Cat√°logo Global (Mestre)
CREATE TABLE IF NOT EXISTS public.global_products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    image TEXT DEFAULT 'https://cdn-icons-png.flaticon.com/512/883/883407.png',
    common BOOLEAN DEFAULT true,
    reference_price NUMERIC DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Produtos das Farm√°cias (FIX: Inclus√£o do unit_type)
CREATE TABLE IF NOT EXISTS public.products (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    price NUMERIC NOT NULL,
    stock INTEGER DEFAULT 0,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    image TEXT DEFAULT 'https://cdn-icons-png.flaticon.com/512/883/883407.png',
    requires_prescription BOOLEAN DEFAULT false,
    category TEXT DEFAULT 'GERAL',
    unit_type TEXT DEFAULT 'Unidade', -- CAMPO CR√çTICO RE-ADICIONADO
    global_product_id UUID REFERENCES public.global_products(id) ON DELETE SET NULL,
    is_promotion BOOLEAN DEFAULT false,
    discount_price NUMERIC,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- GARANTIA: Se a tabela j√° existia, injeta a coluna unit_type agora para matar o erro.
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='products' AND column_name='unit_type') THEN
        ALTER TABLE public.products ADD COLUMN unit_type TEXT DEFAULT 'Unidade';
    END IF;
END $$;

-- Pedidos e Vendas (customer_id isola dados por utente)
CREATE TABLE IF NOT EXISTS public.orders (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    customer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    customer_name TEXT,
    customer_phone TEXT,
    address TEXT,
    items JSONB, 
    total NUMERIC,
    status TEXT DEFAULT 'PENDENTE',
    type TEXT DEFAULT 'DELIVERY', 
    pharmacy_id UUID REFERENCES public.pharmacies(id),
    commission_amount NUMERIC DEFAULT 0,
    commission_status TEXT DEFAULT 'PENDING',
    commission_paid_amount NUMERIC DEFAULT 0,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
-- Migra√ß√£o: se a tabela j√° existir sem customer_id, adicionar:
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='orders' AND column_name='customer_id') THEN
        ALTER TABLE public.orders ADD COLUMN customer_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL;
    END IF;
END $$;

-- Migra√ß√£o financeira: garantir colunas de comiss√£o em bases legadas.
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='orders' AND column_name='commission_amount') THEN
        ALTER TABLE public.orders ADD COLUMN commission_amount NUMERIC DEFAULT 0;
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='orders' AND column_name='commission_status') THEN
        ALTER TABLE public.orders ADD COLUMN commission_status TEXT DEFAULT 'PENDING';
    END IF;
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_schema='public' AND table_name='orders' AND column_name='commission_paid_amount') THEN
        ALTER TABLE public.orders ADD COLUMN commission_paid_amount NUMERIC DEFAULT 0;
    END IF;
END $$;
UPDATE public.orders
SET commission_status = 'PENDING'
WHERE commission_status IS NULL;
UPDATE public.orders
SET commission_paid_amount = COALESCE(commission_amount, 0)
WHERE commission_status = 'PAID' AND COALESCE(commission_paid_amount, 0) = 0;
CREATE INDEX IF NOT EXISTS idx_orders_customer ON public.orders(customer_id);

-- Avalia√ß√µes
CREATE TABLE IF NOT EXISTS public.reviews (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE CASCADE,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    customer_name TEXT,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Receitas M√©dicas
CREATE TABLE IF NOT EXISTS public.prescriptions (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    customer_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    image_url TEXT NOT NULL,
    image_hash TEXT, 
    notes TEXT,
    status TEXT DEFAULT 'ANALYZING',
    target_pharmacies JSONB DEFAULT '[]', 
    ai_metadata JSONB,
    triaged_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Or√ßamentos de Receitas
CREATE TABLE IF NOT EXISTS public.prescription_quotes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    prescription_id UUID REFERENCES public.prescriptions(id) ON DELETE CASCADE,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE CASCADE,
    pharmacy_name TEXT,
    items JSONB,
    total NUMERIC DEFAULT 0,
    delivery_fee NUMERIC DEFAULT 0,
    status TEXT DEFAULT 'RESPONDED',
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Suporte e Notifica√ß√µes
CREATE TABLE IF NOT EXISTS public.support_tickets (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    user_name TEXT,
    user_email TEXT,
    subject TEXT,
    status TEXT DEFAULT 'OPEN',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.support_messages (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    ticket_id UUID REFERENCES public.support_tickets(id) ON DELETE CASCADE,
    sender_id UUID,
    sender_name TEXT,
    sender_role TEXT,
    message TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS public.notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    title TEXT,
    message TEXT,
    type TEXT,
    is_read BOOLEAN DEFAULT false,
    link TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Chatbot History
CREATE TABLE IF NOT EXISTS public.bot_conversations (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    role TEXT CHECK (role IN ('user', 'model')),
    content TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- NOVO v1.4: TABELAS PARA GERENCIAMENTO DE CONTE√öDO DO ADMIN
-- ============================================================================

-- Banners Edit√°veis (Carrossel da p√°gina inicial)
CREATE TABLE IF NOT EXISTS public.admin_banners (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    subtitle TEXT,
    image_url TEXT,
    button_text TEXT DEFAULT 'Ver Mais',
    button_action TEXT DEFAULT 'pharmacies-list', -- P√°gina para onde leva o clique
    "order" INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Perguntas Frequentes (FAQ) Edit√°vel
CREATE TABLE IF NOT EXISTS public.admin_faq (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    "order" INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Sobre N√≥s (About) - Informa√ß√µes da Empresa
CREATE TABLE IF NOT EXISTS public.admin_about (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    section_type TEXT NOT NULL, -- 'mission', 'innovation', 'value'
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    icon_emoji TEXT, -- Para valores: ‚úì, üõ°Ô∏è, ‚ù§Ô∏è, üåç
    "order" INTEGER DEFAULT 1,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Configura√ß√µes do Sistema (Taxa comiss√£o, Whatsapp, Email, etc)
CREATE TABLE IF NOT EXISTS public.system_config (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    config_key TEXT UNIQUE NOT NULL, -- Ex: 'commission_rate', 'min_order_value', 'support_whatsapp'
    config_value TEXT,
    config_type TEXT DEFAULT 'text', -- 'text', 'number', 'boolean', 'json'
    description TEXT,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Auditoria financeira (livro-raz√£o de comiss√µes)
CREATE TABLE IF NOT EXISTS public.financial_ledger (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    order_id UUID REFERENCES public.orders(id) ON DELETE SET NULL,
    pharmacy_id UUID REFERENCES public.pharmacies(id) ON DELETE SET NULL,
    period_key TEXT,
    cycle TEXT DEFAULT 'MONTHLY',
    operation_type TEXT DEFAULT 'SETTLEMENT', -- SETTLEMENT | RESET
    note TEXT,
    applied_amount NUMERIC DEFAULT 0,
    before_paid_amount NUMERIC DEFAULT 0,
    after_paid_amount NUMERIC DEFAULT 0,
    before_status TEXT,
    after_status TEXT,
    created_by UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- 3. SEGURAN√áA AVAN√áADA (ROW LEVEL SECURITY - RLS)
-- ============================================================================

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pharmacies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.prescriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.prescription_quotes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_banners ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_faq ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.admin_about ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.system_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.financial_ledger ENABLE ROW LEVEL SECURITY;

CREATE OR REPLACE FUNCTION is_admin() RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN');
END; $$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION is_pharmacy_owner(p_id UUID) RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND pharmacy_id = p_id);
END; $$ LANGUAGE plpgsql SECURITY DEFINER;

-- POL√çTICAS PROFILES
DROP POLICY IF EXISTS "Profiles Access" ON public.profiles;
CREATE POLICY "Profiles Access" ON public.profiles FOR ALL USING (auth.uid() = id OR is_admin());
DROP POLICY IF EXISTS "Public Profile Insert" ON public.profiles;
CREATE POLICY "Public Profile Insert" ON public.profiles FOR INSERT WITH CHECK (true);

-- POL√çTICAS PHARMACIES
DROP POLICY IF EXISTS "Pharmacy View" ON public.pharmacies;
CREATE POLICY "Pharmacy View" ON public.pharmacies FOR SELECT USING (status = 'APPROVED' OR is_pharmacy_owner(id) OR is_admin());
DROP POLICY IF EXISTS "Pharmacy Owner Manage" ON public.pharmacies;
CREATE POLICY "Pharmacy Owner Manage" ON public.pharmacies FOR UPDATE USING (is_pharmacy_owner(id) OR is_admin());

-- POL√çTICAS PRODUCTS
DROP POLICY IF EXISTS "Product View" ON public.products;
CREATE POLICY "Product View" ON public.products FOR SELECT USING (true);
DROP POLICY IF EXISTS "Product Manage" ON public.products;
CREATE POLICY "Product Manage" ON public.products FOR ALL USING (is_pharmacy_owner(pharmacy_id) OR is_admin());

-- POL√çTICAS ORDERS
DROP POLICY IF EXISTS "Order Select" ON public.orders;
CREATE POLICY "Order Select" ON public.orders
FOR SELECT
USING (
    is_admin()
    OR is_pharmacy_owner(pharmacy_id)
    OR customer_id = auth.uid()
);
DROP POLICY IF EXISTS "Order Insert" ON public.orders;
CREATE POLICY "Order Insert" ON public.orders
FOR INSERT
WITH CHECK (
    is_admin()
    OR customer_id = auth.uid()
);
DROP POLICY IF EXISTS "Order Update" ON public.orders;
CREATE POLICY "Order Update" ON public.orders
FOR UPDATE
USING (is_pharmacy_owner(pharmacy_id) OR is_admin())
WITH CHECK (is_pharmacy_owner(pharmacy_id) OR is_admin());

-- POL√çTICAS PRESCRIPTIONS
DROP POLICY IF EXISTS "RX Access" ON public.prescriptions;
CREATE POLICY "RX Access" ON public.prescriptions FOR ALL USING (customer_id = auth.uid() OR is_admin());
DROP POLICY IF EXISTS "RX Pharmacy View" ON public.prescriptions;
CREATE POLICY "RX Pharmacy View" ON public.prescriptions FOR SELECT USING (
    (target_pharmacies::jsonb ? (SELECT pharmacy_id::text FROM public.profiles WHERE id = auth.uid())) OR
    status IN ('UNDER_REVIEW', 'WAITING_FOR_QUOTES')
);

-- POL√çTICAS ADMIN_BANNERS (Todos podem ver, s√≥ admin pode editar)
DROP POLICY IF EXISTS "Banners Public View" ON public.admin_banners;
CREATE POLICY "Banners Public View" ON public.admin_banners FOR SELECT USING (true);
DROP POLICY IF EXISTS "Banners Admin Edit" ON public.admin_banners;
CREATE POLICY "Banners Admin Edit" ON public.admin_banners FOR ALL USING (is_admin());

-- POL√çTICAS ADMIN_FAQ (Todos podem ver, s√≥ admin pode editar)
DROP POLICY IF EXISTS "FAQ Public View" ON public.admin_faq;
CREATE POLICY "FAQ Public View" ON public.admin_faq FOR SELECT USING (true);
DROP POLICY IF EXISTS "FAQ Admin Edit" ON public.admin_faq;
CREATE POLICY "FAQ Admin Edit" ON public.admin_faq FOR ALL USING (is_admin());

-- POL√çTICAS ADMIN_ABOUT (Todos podem ver, s√≥ admin pode editar)
DROP POLICY IF EXISTS "About Public View" ON public.admin_about;
CREATE POLICY "About Public View" ON public.admin_about FOR SELECT USING (true);
DROP POLICY IF EXISTS "About Admin Edit" ON public.admin_about;
CREATE POLICY "About Admin Edit" ON public.admin_about FOR ALL USING (is_admin());

-- POL√çTICAS SYSTEM_CONFIG (Todos podem ler configs p√∫blicas, s√≥ admin pode editar)
DROP POLICY IF EXISTS "Config Public View" ON public.system_config;
CREATE POLICY "Config Public View" ON public.system_config FOR SELECT USING (true);
DROP POLICY IF EXISTS "Config Admin Edit" ON public.system_config;
CREATE POLICY "Config Admin Edit" ON public.system_config FOR ALL USING (is_admin());

-- POL√çTICAS FINANCIAL_LEDGER (somente admin)
DROP POLICY IF EXISTS "Ledger Admin View" ON public.financial_ledger;
CREATE POLICY "Ledger Admin View" ON public.financial_ledger FOR SELECT USING (is_admin());
DROP POLICY IF EXISTS "Ledger Admin Insert" ON public.financial_ledger;
CREATE POLICY "Ledger Admin Insert" ON public.financial_ledger FOR INSERT WITH CHECK (is_admin());

-- ============================================================================
-- 4. AUTOMA√á√ÉO DE STOCK (FIXED: SUPORTE A ITENS MANUAIS)
-- ============================================================================

CREATE OR REPLACE FUNCTION process_stock_decrement()
RETURNS TRIGGER AS $$
DECLARE
    item JSONB;
    item_id_text TEXT;
    qty INTEGER;
BEGIN
    IF NEW.items IS NOT NULL THEN
        FOR item IN SELECT * FROM jsonb_array_elements(NEW.items)
        LOOP
            item_id_text := item->>'id';
            qty := (item->>'quantity')::INTEGER;

            -- CORRE√á√ÉO CR√çTICA: S√≥ tenta atualizar o stock se o ID for um UUID v√°lido.
            -- Itens manuais (ex: 'rx-...') s√£o ignorados no stock mas mantidos na venda.
            IF item_id_text ~ '^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$' THEN
                UPDATE public.products
                SET stock = stock - qty
                WHERE id = item_id_text::UUID;
            END IF;
        END LOOP;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_decrement_stock ON public.orders;
CREATE TRIGGER tr_decrement_stock AFTER INSERT ON public.orders FOR EACH ROW EXECUTE FUNCTION process_stock_decrement();

CREATE OR REPLACE FUNCTION protect_commission_status_update()
RETURNS TRIGGER AS $$
BEGIN
    IF (
        NEW.commission_status IS DISTINCT FROM OLD.commission_status
        OR COALESCE(NEW.commission_paid_amount, 0) IS DISTINCT FROM COALESCE(OLD.commission_paid_amount, 0)
        OR COALESCE(NEW.commission_amount, 0) IS DISTINCT FROM COALESCE(OLD.commission_amount, 0)
    ) AND NOT is_admin() THEN
        RAISE EXCEPTION 'Somente admin pode alterar campos financeiros de comissao.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_protect_commission_status ON public.orders;
CREATE TRIGGER tr_protect_commission_status
BEFORE UPDATE ON public.orders
FOR EACH ROW EXECUTE FUNCTION protect_commission_status_update();

CREATE OR REPLACE FUNCTION public.get_period_range(period_key TEXT, cycle TEXT)
RETURNS TABLE(start_iso TIMESTAMPTZ, end_iso TIMESTAMPTZ) AS $$
DECLARE
    month_num INTEGER;
    year_num INTEGER;
    week_num INTEGER;
    jan4 DATE;
    week1_monday DATE;
BEGIN
    IF cycle = 'MONTHLY' THEN
        month_num := split_part(period_key, '/', 1)::INTEGER;
        year_num := split_part(period_key, '/', 2)::INTEGER;

        IF month_num < 1 OR month_num > 12 OR year_num < 2000 THEN
            RAISE EXCEPTION 'Periodo mensal invalido: %', period_key;
        END IF;

        start_iso := make_timestamptz(year_num, month_num, 1, 0, 0, 0, 'UTC');
        end_iso := (start_iso + INTERVAL '1 month');
        RETURN NEXT;
        RETURN;
    END IF;

    year_num := split_part(period_key, '-W', 1)::INTEGER;
    week_num := split_part(period_key, '-W', 2)::INTEGER;

    IF week_num < 1 OR week_num > 53 OR year_num < 2000 THEN
        RAISE EXCEPTION 'Periodo semanal invalido: %', period_key;
    END IF;

    jan4 := make_date(year_num, 1, 4);
    week1_monday := jan4 - ((extract(isodow from jan4)::INTEGER) - 1);
    start_iso := (week1_monday + ((week_num - 1) * 7))::TIMESTAMPTZ;
    end_iso := start_iso + INTERVAL '7 day';
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql;

CREATE OR REPLACE FUNCTION public.apply_commission_payment_by_period_admin(
    p_pharmacy_id UUID,
    p_period_key TEXT,
    p_cycle TEXT DEFAULT 'MONTHLY',
    p_payment_amount NUMERIC DEFAULT NULL,
    p_note TEXT DEFAULT NULL
)
RETURNS TABLE(updated_count INTEGER, applied_amount NUMERIC, remaining_amount NUMERIC) AS $$
DECLARE
    v_start TIMESTAMPTZ;
    v_end TIMESTAMPTZ;
    v_remaining NUMERIC;
    v_updated INTEGER := 0;
    v_applied NUMERIC := 0;
    rec RECORD;
    v_commission NUMERIC;
    v_paid NUMERIC;
    v_outstanding NUMERIC;
    v_apply NUMERIC;
    v_next_paid NUMERIC;
    v_next_status TEXT;
BEGIN
    IF NOT is_admin() THEN
        RAISE EXCEPTION 'Somente admin pode liquidar comissao.';
    END IF;

    SELECT start_iso, end_iso
    INTO v_start, v_end
    FROM public.get_period_range(p_period_key, p_cycle);

    v_remaining := COALESCE(NULLIF(p_payment_amount, 0), 1e18);

    FOR rec IN
        SELECT id, pharmacy_id, commission_amount, commission_status, commission_paid_amount, created_at, status
        FROM public.orders
        WHERE pharmacy_id = p_pharmacy_id
          AND created_at >= v_start
          AND created_at < v_end
          AND status IN ('Conclu√≠do', 'Concluido', 'COMPLETED')
        ORDER BY created_at ASC
        FOR UPDATE
    LOOP
        EXIT WHEN v_remaining <= 0;

        v_commission := COALESCE(rec.commission_amount, 0);
        v_paid := LEAST(
            v_commission,
            GREATEST(
                0,
                COALESCE(rec.commission_paid_amount, 0)
                + CASE WHEN rec.commission_status = 'PAID' AND COALESCE(rec.commission_paid_amount, 0) <= 0 THEN v_commission ELSE 0 END
            )
        );
        v_outstanding := GREATEST(0, v_commission - v_paid);
        IF v_outstanding <= 0 THEN
            CONTINUE;
        END IF;

        v_apply := LEAST(v_outstanding, v_remaining);
        v_next_paid := v_paid + v_apply;
        v_next_status := CASE WHEN v_next_paid >= v_commission THEN 'PAID' ELSE 'PARTIAL' END;

        UPDATE public.orders
        SET commission_paid_amount = v_next_paid,
            commission_status = v_next_status
        WHERE id = rec.id;

        INSERT INTO public.financial_ledger (
            order_id, pharmacy_id, period_key, cycle, operation_type, note,
            applied_amount, before_paid_amount, after_paid_amount,
            before_status, after_status, created_by
        ) VALUES (
            rec.id, rec.pharmacy_id, p_period_key, p_cycle, 'SETTLEMENT', p_note,
            v_apply, v_paid, v_next_paid,
            rec.commission_status, v_next_status, auth.uid()
        );

        v_updated := v_updated + 1;
        v_applied := v_applied + v_apply;
        v_remaining := v_remaining - v_apply;
    END LOOP;

    updated_count := v_updated;
    applied_amount := v_applied;
    remaining_amount := CASE WHEN p_payment_amount IS NULL OR p_payment_amount <= 0 THEN 0 ELSE GREATEST(0, v_remaining) END;
    RETURN NEXT;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Ferramenta administrativa: reset controlado das dividas de comissao (opcional por farm√°cia).
CREATE OR REPLACE FUNCTION public.reset_commission_debt_admin(target_pharmacy_id UUID DEFAULT NULL)
RETURNS INTEGER AS $$
DECLARE
    affected_rows INTEGER := 0;
    rec RECORD;
BEGIN
    IF NOT is_admin() THEN
        RAISE EXCEPTION 'Somente admin pode executar reset de divida.';
    END IF;

    FOR rec IN
        SELECT id, pharmacy_id, commission_paid_amount, commission_status
        FROM public.orders
        WHERE (
            target_pharmacy_id IS NULL OR pharmacy_id = target_pharmacy_id
        )
        AND status IN ('Conclu√≠do', 'Concluido', 'COMPLETED')
        FOR UPDATE
    LOOP
        UPDATE public.orders
        SET commission_status = 'PENDING',
            commission_paid_amount = 0
        WHERE id = rec.id;

        INSERT INTO public.financial_ledger (
            order_id, pharmacy_id, period_key, cycle, operation_type, note,
            applied_amount, before_paid_amount, after_paid_amount,
            before_status, after_status, created_by
        ) VALUES (
            rec.id, rec.pharmacy_id, NULL, 'MONTHLY', 'RESET', 'Reset administrativo de d√≠vida',
            0, COALESCE(rec.commission_paid_amount, 0), 0,
            rec.commission_status, 'PENDING', auth.uid()
        );

        affected_rows := affected_rows + 1;
    END LOOP;

    RETURN affected_rows;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- ============================================================================
-- 5. GATILHOS DE NOTIFICA√á√ÉO (SISTEMA DE ALERTAS RESTAURADO)
-- ============================================================================

-- Notificar Cliente sobre Or√ßamento
CREATE OR REPLACE FUNCTION notify_customer_on_quote()
RETURNS trigger AS $$
BEGIN
    INSERT INTO notifications (user_id, title, message, type)
    SELECT customer_id, 'OR√áAMENTO RECEBIDO üí∞', 'A ' || NEW.pharmacy_name || ' respondeu √† tua receita. Toque para ver.', 'RX_RESPONSE'
    FROM prescriptions WHERE id = NEW.prescription_id;
    RETURN NEW;
END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_notify_quote ON prescription_quotes;
CREATE TRIGGER tr_notify_quote AFTER INSERT ON prescription_quotes FOR EACH ROW EXECUTE FUNCTION notify_customer_on_quote();

-- Notificar Farm√°cias sobre novas Receitas/Triagens
CREATE OR REPLACE FUNCTION notify_pharmacies_on_rx()
RETURNS trigger AS $$
DECLARE
    target_p_id TEXT;
    expert_user_id UUID;
    customer_name TEXT;
BEGIN
    SELECT name INTO customer_name FROM profiles WHERE id = NEW.customer_id;
    IF customer_name IS NULL THEN customer_name := 'UM UTENTE'; END IF;

    -- 1. Triagem (Letra Dif√≠cil)
    IF NEW.status = 'UNDER_REVIEW' THEN
        FOR expert_user_id IN (SELECT p.id FROM profiles p JOIN pharmacies ph ON p.pharmacy_id = ph.id WHERE ph.receives_low_conf_rx = true) LOOP
            INSERT INTO notifications (user_id, title, message, type)
            VALUES (expert_user_id, 'LETRA DIF√çCIL PARA ANALISAR', 'Uma receita de ' || customer_name || ' precisa da tua ajuda profissional.', 'RX_TRIAGE');
        END LOOP;

    -- 2. Cota√ß√£o Direta
    ELSIF NEW.status = 'WAITING_FOR_QUOTES' THEN
        IF NEW.target_pharmacies IS NOT NULL AND jsonb_typeof(NEW.target_pharmacies) = 'array' THEN
            FOR target_p_id IN (SELECT jsonb_array_elements_text(NEW.target_pharmacies)) LOOP
                INSERT INTO notifications (user_id, title, message, type)
                SELECT id, 'PEDIDO DE OR√áAMENTO', 'Recebeste uma nova receita de ' || customer_name || ' para cotar.', 'RX_QUOTE'
                FROM profiles WHERE pharmacy_id = target_p_id::uuid;
            END LOOP;
        END IF;
    END IF;

    RETURN NEW;
END; $$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS tr_notify_rx ON prescriptions;
CREATE TRIGGER tr_notify_rx AFTER INSERT OR UPDATE OF status ON prescriptions FOR EACH ROW EXECUTE FUNCTION notify_pharmacies_on_rx();

-- 6. √çNDICES DE PERFORMANCE
CREATE INDEX IF NOT EXISTS idx_products_name_trgm ON public.products USING gin (name gin_trgm_ops);
CREATE INDEX IF NOT EXISTS idx_orders_pharmacy ON public.orders(pharmacy_id);
CREATE INDEX IF NOT EXISTS idx_orders_commission_status_created_at ON public.orders(commission_status, created_at);
CREATE INDEX IF NOT EXISTS idx_orders_commission_paid_amount ON public.orders(commission_paid_amount);
CREATE INDEX IF NOT EXISTS idx_prescriptions_customer ON public.prescriptions(customer_id);
CREATE INDEX IF NOT EXISTS idx_admin_banners_order ON public.admin_banners("order");
CREATE INDEX IF NOT EXISTS idx_admin_faq_order ON public.admin_faq("order");
CREATE INDEX IF NOT EXISTS idx_system_config_key ON public.system_config(config_key);
CREATE INDEX IF NOT EXISTS idx_financial_ledger_order ON public.financial_ledger(order_id);
CREATE INDEX IF NOT EXISTS idx_financial_ledger_pharmacy_created ON public.financial_ledger(pharmacy_id, created_at DESC);

-- ============================================================================
-- 7. DADOS INICIAIS PADR√ÉO (v1.4)
-- ============================================================================

-- Inserir dados iniciais de FAQ (se a tabela estiver vazia)
INSERT INTO public.admin_faq (question, answer, "order", is_active)
SELECT * FROM (VALUES
  ('Como compro na FarmoLink?', 'Podes pesquisar diretamente pelo nome do medicamento na tela inicial, ou tirar uma foto da tua receita m√©dica. A IA analisar√° a receita e mostrar√° os medicamentos dispon√≠veis nas farm√°cias mais pr√≥ximas, com os respetivos pre√ßos.', 1, true),
  ('Faz entregas?', 'Sim! Algumas farm√°cias t√™m entrega pr√≥pria e outras permitem apenas levantamento em loja. Quando fazes a compra, a plataforma j√° indica se a farm√°cia faz entrega ou levantamento.', 2, true),
  ('Precisa da receita f√≠sica?', 'SIM. A entrega de medicamentos sujeitos a receita m√©dica s√≥ ser√° feita se entregares a receita original f√≠sica ao estafeta. Isto √© uma exig√™ncia legal em Angola e protege a tua sa√∫de.', 3, true),
  ('Como pago?', 'Diretamente √† farm√°cia ou ao estafeta no ato da entrega. Aceitamos pagamento via TPA (Multicaixa), MCX Express ou dinheiro.', 4, true),
  ('A IA pode errar a ler a receita?', 'Sim, a IA √© apenas um assistente. O farmac√™utico da farm√°cia far√° sempre uma verifica√ß√£o manual da foto da receita antes de preparar a encomenda. A seguran√ßa √© prioridade.', 5, true),
  ('Os pre√ßos s√£o iguais √† loja?', 'Sim. As farm√°cias parceiras comprometem-se a praticar os mesmos pre√ßos que cobram no balc√£o f√≠sico. Sem surpresas.', 6, true),
  ('Os meus dados est√£o seguros?', 'Sim. Todos os teus dados s√£o criptografados e protegidos conforme a Lei de Prote√ß√£o de Dados de Angola (APD). Usamos servidores seguros e n√£o partilhamos informa√ß√µes pessoais com terceiros sem consentimento.', 7, true),
  ('Posso devolver um medicamento?', 'Medicamentos s√≥ podem ser devolvidos se chegarem danificados ou com defeito. Contacta-nos imediatamente se isto acontecer e solucionaremos o problema.', 8, true)
) t(question, answer, "order", is_active)
WHERE NOT EXISTS (SELECT 1 FROM public.admin_faq LIMIT 1);

-- Inserir dados iniciais de Sobre N√≥s
INSERT INTO public.admin_about (section_type, title, content, icon_emoji, "order", is_active)
SELECT * FROM (VALUES
  ('mission', 'Nossa Miss√£o', 'Digitalizar o ecossistema farmac√™utico angolano, proporcionando transpar√™ncia de pre√ßos e conveni√™ncia para todos os utilizadores, de Luanda a Cabinda.', 'üåç', 1, true),
  ('innovation', 'Inova√ß√£o Local', 'Criado por angolanos para angolanos, entendemos os desafios log√≠sticos e de literacia digital. Trabalhamos diretamente com farmac√™uticos para oferecer solu√ß√µes reais.', '‚ö°', 2, true),
  ('value', 'Transpar√™ncia', 'Pre√ßos reais das farm√°cias em tempo real, sem surpresas.', '‚úì', 3, true),
  ('value', 'Seguran√ßa', 'Dados protegidos conforme a Lei de Prote√ß√£o de Dados de Angola (APD).', 'üõ°Ô∏è', 4, true),
  ('value', '√âtica', 'Sempre exigimos a receita original para entrega de medicamentos.', '‚ù§Ô∏è', 5, true),
  ('value', 'Acessibilidade', 'Feito para funcionar em qualquer telem√≥vel com dados m√≥veis.', 'üåç', 6, true)
) t(section_type, title, content, icon_emoji, "order", is_active)
WHERE NOT EXISTS (SELECT 1 FROM public.admin_about LIMIT 1);

-- Inserir dados iniciais de Configura√ß√µes do Sistema
INSERT INTO public.system_config (config_key, config_value, config_type, description)
SELECT * FROM (VALUES
  ('commission_rate', '10', 'number', 'Taxa de comiss√£o padr√£o (%)'),
  ('min_order_value', '2000', 'number', 'Valor m√≠nimo de pedido (Kz)'),
  ('support_whatsapp', '244936793706', 'text', 'N√∫mero de WhatsApp do suporte'),
  ('support_email', 'ajuda@farmolink.ao', 'text', 'Email de suporte'),
  ('app_name', 'FarmoLink Angola', 'text', 'Nome da aplica√ß√£o'),
  ('app_version', '1.4.0', 'text', 'Vers√£o atual da aplica√ß√£o'),
  ('legal_updated_at', '2026-02-12', 'text', 'Data da ultima atualizacao legal (YYYY-MM-DD)'),
  ('legal_privacy_policy', 'Politica de Privacidade FarmoLink: coletamos dados de cadastro, uso da plataforma, pedidos e informacoes relacionadas a receitas para executar o servico com seguranca. Dados de saude recebem controles reforcados de acesso e criptografia. Compartilhamos informacoes apenas com farmacias parceiras e fornecedores estritamente necessarios para processar pedidos, suporte e obrigacoes legais. O titular pode solicitar correcao e atualizacao de dados pelos canais oficiais. Nao vendemos dados pessoais. Retemos informacoes pelo periodo necessario para operacao, auditoria e cumprimento legal aplicavel. Ao continuar a usar a plataforma, o utilizador reconhece e aceita esta politica na versao vigente.', 'text', 'Conteudo da Politica de Privacidade'),
  ('legal_terms_of_use', 'Termos de Uso FarmoLink: a plataforma intermedeia pedidos entre utentes e farmacias parceiras e nao substitui consulta medica. Medicamentos sujeitos a receita exigem validacao profissional e cumprimento das regras legais aplicaveis. O utilizador deve fornecer dados verdadeiros, manter credenciais seguras e usar a plataforma de forma licita. E proibido tentar adquirir medicamentos controlados sem receita valida, praticar fraude ou uso abusivo do sistema. Preco, disponibilidade, entrega e dispensacao sao definidos pela farmacia parceira, com possibilidade de recusas por motivos tecnicos, regulatorios ou de stock. A FarmoLink pode suspender contas em caso de violacao destes termos.', 'text', 'Conteudo dos Termos de Uso'),
  ('financial_settlement_cycle', 'MONTHLY', 'text', 'Periodicidade de liquidacao financeira (MONTHLY|WEEKLY)')
) t(config_key, config_value, config_type, description)
ON CONFLICT (config_key) DO NOTHING;

-- Atualizacao de contato WhatsApp (garante numero mais recente em bases existentes).
UPDATE public.system_config
SET config_value = '244936793706',
    updated_at = NOW()
WHERE config_key = 'support_whatsapp';

-- Garantia legal: se a base ja existir com placeholders/vazios, preencher com texto adequado.
UPDATE public.system_config
SET config_value = 'Politica de Privacidade FarmoLink: coletamos dados de cadastro, uso da plataforma, pedidos e informacoes relacionadas a receitas para executar o servico com seguranca. Dados de saude recebem controles reforcados de acesso e criptografia. Compartilhamos informacoes apenas com farmacias parceiras e fornecedores estritamente necessarios para processar pedidos, suporte e obrigacoes legais. O titular pode solicitar correcao e atualizacao de dados pelos canais oficiais. Nao vendemos dados pessoais. Retemos informacoes pelo periodo necessario para operacao, auditoria e cumprimento legal aplicavel. Ao continuar a usar a plataforma, o utilizador reconhece e aceita esta politica na versao vigente.',
    updated_at = NOW()
WHERE config_key = 'legal_privacy_policy'
  AND (
    config_value IS NULL
    OR btrim(config_value) = ''
    OR config_value ILIKE 'Texto padrao%'
  );

UPDATE public.system_config
SET config_value = 'Termos de Uso FarmoLink: a plataforma intermedeia pedidos entre utentes e farmacias parceiras e nao substitui consulta medica. Medicamentos sujeitos a receita exigem validacao profissional e cumprimento das regras legais aplicaveis. O utilizador deve fornecer dados verdadeiros, manter credenciais seguras e usar a plataforma de forma licita. E proibido tentar adquirir medicamentos controlados sem receita valida, praticar fraude ou uso abusivo do sistema. Preco, disponibilidade, entrega e dispensacao sao definidos pela farmacia parceira, com possibilidade de recusas por motivos tecnicos, regulatorios ou de stock. A FarmoLink pode suspender contas em caso de violacao destes termos.',
    updated_at = NOW()
WHERE config_key = 'legal_terms_of_use'
  AND (
    config_value IS NULL
    OR btrim(config_value) = ''
    OR config_value ILIKE 'Texto padrao%'
  );

-- Inserir dados iniciais de Banners (exemplo)
INSERT INTO public.admin_banners (title, subtitle, button_text, "order", is_active)
SELECT * FROM (VALUES
  ('Medicamentos em Promo√ß√£o', 'Descontos especiais esta semana at√© 50%', 'Ver Ofertas', 1, true),
  ('Novos Parceiros Dispon√≠veis', 'Farm√°cias de qualidade perto de ti', 'Explorar', 2, true)
) t(title, subtitle, button_text, "order", is_active)
WHERE NOT EXISTS (SELECT 1 FROM public.admin_banners LIMIT 1);

NOTIFY pgrst, 'reload schema';

-- ============================================================================
-- SUM√ÅRIO DE MUDAN√áAS v1.4
-- ============================================================================
-- ‚ú® NOVAS TABELAS:
--    1. admin_banners - Carrossel de banners da p√°gina inicial (t√≠tulo, subt√≠tulo, imagem, bot√£o)
--    2. admin_faq - Perguntas Frequentes geridas pelo admin
--    3. admin_about - Informa√ß√µes sobre a empresa (miss√£o, inova√ß√£o, valores)
--    4. system_config - Configura√ß√µes globais do sistema (taxa comiss√£o, whatsapp, email, etc)
--
-- ‚ú® NOVAS POL√çTICAS RLS:
--    - Todos podem ler banners, FAQ e About (p√∫blico)
--    - S√≥ admin pode editar estas tabelas
--
-- ‚ú® DADOS INICIAIS:
--    - 8 FAQs pr√©-preenchidas em portugu√™s
--    - 6 informa√ß√µes sobre n√≥s (miss√£o, inova√ß√£o, 4 valores)
--    - 10 configuracoes do sistema padrao (inclui textos legais e ciclo financeiro)
--    - 2 banners de exemplo
--
-- üìå INSTRU√á√ïES PARA DEPLOY:
--    1. Copiar todo este SQL para o editor do Supabase (SQL Editor)
--    2. Executar todo o script
--    3. Verificar se todas as tabelas foram criadas: admin_banners, admin_faq, admin_about, system_config
--    4. Confirmar que as pol√≠ticas RLS est√£o ativas em cada tabela
--    5. No app, os dados aparecer√£o automaticamente nas abas de CONFIGURA√á√ïES do Admin
-- ============================================================================

